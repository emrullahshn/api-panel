{% extends 'base.html.twig' %}

{% block stylesheets %}
  <link rel="stylesheet" href="{{ asset('build/login-page.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.0/css/lightbox.min.css">
{% endblock %}

{% block bodyCustomClass %}{% spaceless %}
  kt-app__aside--left kt-quick-panel--right kt-demo-panel--right kt-offcanvas-panel--right kt-header--fixed kt-header-mobile--fixed kt-subheader--solid kt-aside--enabled kt-aside--fixed kt-aside--minimize
{% endspaceless %}{% endblock %}

{% block javascripts %}
  {{ parent() }}

  <script type="text/javascript">
    $(function () {
      $('#attachment').on('click', function(e) {
        e.preventDefault();

        $('#file').trigger('click')
      })

      $('a.action-delete').on('click', function (e) {
        e.preventDefault();

        $('#modal-delete').modal({backdrop: true, keyboard: true})
          .off('click', '#modal-delete-button')
          .on('click', '#modal-delete-button', function () {
            $('#delete-form').trigger('submit');
          });
      });

      $("#add-ticket-message").on('submit', function (e) {
        e.preventDefault();
        var form = $(this);
        const replyContent = $('#replyContent');

        form.ajaxSubmit({
                          success: function(data) {
                            var html = ''

                            for(var key in data['files']) {
                              var file = data['files'][key]
                              html += `
                                <a href="${file}"
                                 data-lightbox="${file}"
                                 data-title="${file}" style="display: block; margin-bottom: .5rem;">
                                  <img src="${file}" alt="${file}">
                                </a>
                              `
                            }

                            $(".kt-chat__messages").append(`
                            <div class="kt-chat__message kt-chat__message--right">
                                <div class="kt-chat__text kt-bg-light-brand">
                                    ${replyContent.val()}

                                  ${html}
                                </div>
                            </div>
                        `)

                            replyContent.val('');
                          }
                        })
      });
    });
  </script>
{% endblock %}

{% block content %}
  <div class="kt-grid__item kt-grid__item--fluid kt-grid kt-grid--hor kt-wrapper" id="kt_wrapper">

    {% include 'components/aside-base.html.twig' %}

    {% include 'components/header-base.html.twig' %}

    <!-- begin:: Content -->


    <div class="kt-content kt-grid__item kt-grid__item--fluid" id="kt_content">
      <div class="row">
        <form action="{{ path('add_ticket_message') }}" method="post" class="col-12 col-sm-12" id="add-ticket-message" enctype="multipart/form-data">
          <div class="kt-grid__item kt-grid__item--fluid kt-app__content" id="kt_chat_content">
            <div class="kt-chat">
              <div class="kt-portlet kt-portlet--head-lg kt-portlet--last">
                <div class="kt-portlet__head">
                  <div class="kt-chat__head ">
                    <div class="kt-chat__left"></div>

                    <div class="kt-chat__center">
                      <div class="kt-chat__label">
                        <a href="#" class="kt-chat__title">{{ ticket.subject|default('') }}</a>
                      </div>
                    </div>

                    <div class="kt-chat__right"></div>
                  </div>
                </div>

                <div class="kt-portlet__body">
                  <div class="kt-scroll kt-scroll--pull" data-mobile-height="300" data-desktop-height="500">
                    <div class="kt-chat__messages">
                      {% for message in ticket.messages %}
                        {% set position = '' %}
                        {% set class = 'kt-bg-light-brand' %}

                        {% if message.status == 2 %}
                          {% set position = ' kt-chat__message--right' %}
                          {% set class = 'kt-bg-light-brand' %}
                        {% endif %}

                        <div class="kt-chat__message{{ position }}">
                           <div class="kt-chat__user">
                            <span class="kt-chat__datetime">
                              {{ ticket.createdAt|date('d.m.Y') }}
                            </span>
                            <a href="#" class="kt-chat__username">
                              {{ ticket.user.fullName }}
                            </a>
                          </div>
                          <div class="kt-chat__text kt-bg-light-success">
                            {{ message.message }}

                            {% for index, image in message.imageRaw if message.imageRaw is not empty %}
                              <a href="{{ asset('uploads/' ~ index) }}"
                                 data-lightbox="{{ index }}"
                                 data-title="{{ index }}" style="display: block;margin-bottom: .5rem;">
                                <img src="{{ asset('uploads/' ~ index) }}" width="75" height="auto" alt="{{ index }}">
                              </a>
                            {% endfor %}
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>

                <div class="kt-portlet__foot">
                  <div class="kt-chat__input">
                    <div class="kt-chat__editor">
                      <textarea style="height: 50px; width: 100%;" placeholder="{% if ticket.status == 'CLOSED' %}Talep Kapandı{% else %}Buraya yazın{% endif %}" name="replyContent" id="replyContent"{% if ticket.status == 'CLOSED' %} disabled{% endif %}></textarea>
                      <input type="hidden" id="userName" value="{{ ticket.user.fullName }}">
                      <input type="hidden" id="status" name="status" value="2">
                      <input type="hidden" id="ticketId" name="ticketId" value="{{ ticket.id }}">
                    </div>
                    <div class="kt-chat__toolbar">
                      <div class="kt_chat__tools">
                        <a href="#" id="attachment"><i class="flaticon2-link"></i></a>
                        <div style="display: none;">
                          <div class="custom-file">
                            <input type="file" class="custom-file-input" id="file" name="file[]" multiple{% if ticket.status == 'CLOSED' %} disabled{% endif %}>
                            <label class="custom-file-label" for="file">{{ 'createTicket.file'|trans }}</label>
                          </div>
                        </div>
                      </div>
                      <div class="kt_chat__actions">
                        <button type="submit" class="btn btn-brand btn-md btn-upper btn-bold kt-chat__reply"
                                {% if ticket.status == 'CLOSED' %}style="display: none;"{% endif %}
                        >
                          {{ 'answerTicket.send'|trans }}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- end:: Content -->

    {% include 'components/footer-base.html.twig' %}
  </div>
  </div>
{% endblock %}
